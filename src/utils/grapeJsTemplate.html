<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GrapeJS Editor</title>
  <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #gjs {
      height: 100%;
      width: 100%;
      border: 0;
    }
    .gjs-block {
      width: auto;
      height: auto;
      min-height: 48px;
    }
  </style>
</head>
<body>
  <div id="gjs"></div>
  
  <script src="https://unpkg.com/grapesjs"></script>
  <script>
    // Initialize GrapeJS editor
    const editor = grapesjs.init({
      container: '#gjs',
      height: '100%',
      width: 'auto',
      storageManager: false,
      panels: { defaults: [] },
      deviceManager: {
        devices: [
          { name: 'Desktop', width: '' },
          { name: 'Tablet', width: '768px', widthMedia: '992px' },
          { name: 'Mobile', width: '320px', widthMedia: '480px' },
        ]
      },
      canvas: {
        styles: [],
        scripts: [],
      }
    });

    // RPC Communication System
    const rpcHandlers = {};
    let rpcId = 0;
    const pendingRPC = new Map();

    // Register RPC handlers
    function registerRPCHandler(method, handler) {
      rpcHandlers[method] = handler;
    }

    // Send RPC message to parent
    function sendRPC(method, params) {
      return new Promise((resolve, reject) => {
        const id = ++rpcId;
        pendingRPC.set(id, { resolve, reject });
        window.parent.postMessage({
          type: 'rpc-request',
          id,
          method,
          params
        }, '*');
      });
    }

    // Handle incoming messages
    window.addEventListener('message', (event) => {
      const { type, id, method, params, result, error } = event.data;

      if (type === 'rpc-request') {
        // Handle incoming RPC call
        const handler = rpcHandlers[method];
        if (handler) {
          Promise.resolve(handler(params))
            .then(result => {
              window.parent.postMessage({
                type: 'rpc-response',
                id,
                result
              }, '*');
            })
            .catch(error => {
              window.parent.postMessage({
                type: 'rpc-response',
                id,
                error: error.message
              }, '*');
            });
        }
      } else if (type === 'rpc-response') {
        // Handle RPC response
        const pending = pendingRPC.get(id);
        if (pending) {
          pendingRPC.delete(id);
          if (error) {
            pending.reject(new Error(error));
          } else {
            pending.resolve(result);
          }
        }
      }
    });

    // Register GrapeJS API methods
    registerRPCHandler('getHtml', () => {
      return editor.getHtml();
    });

    registerRPCHandler('getCss', () => {
      return editor.getCss();
    });

    registerRPCHandler('getJs', () => {
      return editor.getJs();
    });

    registerRPCHandler('setComponents', ({ components }) => {
      editor.setComponents(components);
      return { success: true };
    });

    registerRPCHandler('getComponents', () => {
      return editor.getComponents();
    });

    registerRPCHandler('addComponents', ({ components, options }) => {
      editor.addComponents(components, options);
      return { success: true };
    });

    registerRPCHandler('setStyle', ({ style }) => {
      editor.setStyle(style);
      return { success: true };
    });

    registerRPCHandler('getStyle', () => {
      return editor.getStyle();
    });

    registerRPCHandler('clear', () => {
      editor.DomComponents.clear();
      editor.CssComposer.clear();
      return { success: true };
    });

    registerRPCHandler('undo', () => {
      editor.UndoManager.undo();
      return { success: true };
    });

    registerRPCHandler('redo', () => {
      editor.UndoManager.redo();
      return { success: true };
    });

    registerRPCHandler('getDevice', () => {
      return editor.getDevice();
    });

    registerRPCHandler('setDevice', ({ device }) => {
      editor.setDevice(device);
      return { success: true };
    });

    // Notify parent when editor is ready
    editor.on('load', () => {
      sendRPC('editorReady', { ready: true });
      console.log('[GrapeJS] Editor loaded and ready');
    });

    // Notify parent on changes
    editor.on('component:add component:remove component:update', () => {
      sendRPC('editorChanged', {
        html: editor.getHtml(),
        css: editor.getCss()
      });
    });

    // Log console messages to parent
    const originalConsole = {
      log: console.log,
      warn: console.warn,
      error: console.error
    };

    ['log', 'warn', 'error'].forEach(method => {
      console[method] = (...args) => {
        originalConsole[method](...args);
        sendRPC('console', { type: method, args });
      };
    });

    console.log('[GrapeJS] Iframe initialized');
  </script>
</body>
</html>
